<div class="w-full space-y-4 px-6">
  <div class="flex justify-between p-6 pb-2">
    <h1 class="text-3xl font-bold text-textp">Itinerary</h1>
    <span class="btn btn-secondary rounded-full hover:cursor-default">
      {{ [trip!.startDate!, trip!.endDate!] | dateRange }}
    </span>
  </div>
  <section
    *ngFor="let day of trip?.itinerary; let dayIndex = index"
    [class]="'section-' + dayIndex + ' scroll-m-20'"
  >
    <div class="collapse collapse-arrow bg-base-100 text-textp">
      <input checked type="checkbox" />
      <div
        class="collapse-title text-xl font-semibold underline underline-offset-4"
      >
        {{ day.Date | customDateFormat }}
      </div>
      <div class="collapse-content">
        <div class="mb-8 flex">
          <input
            type="text"
            placeholder="Add subheading"
            class="input input-ghost input-sm -ml-2 -mt-2 w-full max-w-sm text-ellipsis text-xl font-medium text-texts underline underline-offset-4"
            #subheadingInput
            (blur)="
              saveSubheading(day.subheading!, subheadingInput.value, dayIndex)
            "
            [value]="day.subheading"
          />
          <span
            *ngIf="subheadingSaving.value && subheadingSaving.index == dayIndex"
            class="loading loading-spinner loading-sm ml-2 text-primary"
          ></span>
        </div>
        <div
          *ngFor="let place of day.places; let placeIndex = index"
          class="my-3 flex flex-row space-x-2"
        >
          <div
            (click)="onPlaceClick(place)"
            class="collapse collapse-open basis-2/3 bg-secondary"
          >
            <input type="checkbox" />

            <div class="exclude-this collapse-title text-xl font-medium">
              <button
                type="button"
                class="btn btn-circle btn-sm bg-red-600 text-white"
              >
                {{ dayIndex + 1 }}.{{ placeIndex + 1 }}
              </button>
              {{ place.name }}
            </div>
            <div class="collapse-content text-textp">
              <textarea
                (click)="$event.stopPropagation()"
                #placeDescTextArea
                class="textarea w-full bg-base-100"
                appAutoResizeTextarea
                placeholder="Write a description about this place"
                (blur)="
                  updatePlaceDescription(
                    place.description!,
                    placeDescTextArea.value,
                    dayIndex,
                    placeIndex
                  )
                "
                >{{ place.description }}</textarea
              >
              <div
                *ngIf="
                  descriptionSaving.value &&
                  descriptionSaving.dayIndex == dayIndex &&
                  descriptionSaving.placeIndex == placeIndex
                "
                class="flex justify-end"
              >
                saving
                <span class="loading loading-dots loading-xs ml-1 mt-2"></span>
              </div>
              <div class="relative">
                <span class="absolute -left-1 -top-1 text-2xl text-yellow-500">
                  <i class="fa-solid fa-note-sticky"></i>
                </span>
                <textarea
                  #notesTextArea
                  class="textarea w-full bg-base-100"
                  appAutoResizeTextarea
                  placeholder="Write or paste notes here"
                  >{{ place.note }}</textarea
                >
              </div>

              <div class="mb-2 mt-4 flex items-center justify-start space-x-3">
                <button
                  *ngIf="!place.time"
                  class="btn btn-outline btn-xs rounded-full bg-indigo-600 text-xs normal-case text-white"
                >
                  <i class="fa-regular fa-clock"></i> Add time</button
                ><button
                  class="btn btn-outline btn-xs hidden rounded-full bg-indigo-600 text-xs normal-case text-white"
                >
                  <i class="fa-solid fa-paperclip"></i> Attach</button
                ><button
                  *ngIf="!place.expense"
                  class="btn btn-outline btn-xs rounded-full bg-indigo-600 text-xs normal-case text-white"
                >
                  <i class="fa-solid fa-indian-rupee-sign"></i> Add cost
                </button>
              </div>
            </div>
          </div>
          <div class="mt-1 w-full basis-1/3 space-y-2">
            <div class="relative h-32 w-full">
              <img
                class="h-32 w-full rounded-lg object-cover"
                src="{{ place.image }}"
                alt=""
              />
              <div>
                <div
                  *ngIf="
                    changeImageLoading.value &&
                    changeImageLoading.dayIndex == dayIndex &&
                    changeImageLoading.placeIndex == placeIndex
                  "
                  class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-70 text-primary"
                >
                  <span class="loading loading-spinner loading-lg"></span>
                </div>
              </div>
            </div>

            <input
              accept=".jpg,.jpeg,.png"
              type="file"
              #fileInput
              style="display: none"
              (change)="onFileSelected($event, dayIndex, placeIndex)"
            />
            <button
              type="button"
              class="btn btn-success btn-outline btn-sm w-full rounded-full normal-case"
              (click)="fileInput.click()"
            >
              <i class="fa-solid fa-pen"></i>
              Change photo
            </button>
            <button
              type="button"
              class="btn btn-error btn-sm w-full rounded-full normal-case text-white"
            >
              <i class="fa-solid fa-trash-can"></i>
              Delete place
            </button>
          </div>
        </div>

        <div
          *ngIf="addPlaceLoading.value && addPlaceLoading.id == day._id"
          class="collapse collapse-open my-3 bg-secondary"
        >
          <input type="checkbox" />
          <div
            class="exclude-this collapse-title text-xl font-medium text-textg"
          >
            <span class="loading loading-dots loading-md ml-5"></span>
          </div>
          <div
            class="collapse-content flex items-center justify-center text-textg"
          >
            <span class="loading loading-spinner loading-md"></span>
          </div>
        </div>

        <div class="input-with-icon flex w-full">
          <span class="m-2 text-2xl text-textg">
            <i class="fa-solid fa-location-dot"></i>
          </span>
          <input
            type="text"
            [formControl]="inputControl"
            placeholder="Add a place"
            class="input flex-grow bg-secondary"
            (focus)="onFocus(dayIndex)"
            (blur)="blurResults()"
            (keydown)="onKeyDown($event, day._id!, dayIndex)"
          />
        </div>
        <ul
          class="ml-8 mt-2 w-auto max-w-full rounded border border-gray-300 bg-secondary shadow-lg"
          *ngIf="
            places.length > 0 && showResults && showResultsIndex == dayIndex
          "
        >
          <li
            class="cursor-pointer px-4 py-2 text-textp hover:bg-gray-300"
            *ngFor="let place of places; let i = index"
            [class.bg-gray-300]="i === selectedPlaceIndex"
            (click)="selectPlace(place, day._id!, dayIndex)"
          >
            <p>{{ place.text }}</p>
            <span class="text-sm text-texts">{{ place.place_name }}</span>
          </li>
        </ul>
      </div>
    </div>
  </section>
</div>
